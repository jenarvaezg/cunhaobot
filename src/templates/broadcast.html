{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="glass-card p-5 animate__animated animate__fadeIn">
            <h1 class="hero-title oswald mb-4">üì¢ BROADCAST MAESTRO</h1>
            <p class="text-muted mb-4">Env√≠a sabidur√≠a a todos los m√°quinas. Puedes mandar solo texto, o una imagen/v√≠deo con un mensaje opcional.</p>

            <div class="mb-4">
                <label for="message" class="form-label fw-bold text-warning">Mensaje a difundir</label>
                <textarea class="form-control glass-card bg-transparent text-white border-secondary"
                          id="message" name="message" rows="4"
                          placeholder="Escribe aqu√≠ tu sabidur√≠a..."></textarea>
            </div>

            <div id="drop-area" class="border border-2 border-dashed border-warning rounded-4 p-5 text-center mb-4"
                 style="cursor: pointer; transition: all 0.3s; background: rgba(255, 193, 7, 0.05);">
                <i class="bi bi-cloud-upload fs-1 text-warning mb-3"></i>
                <h3 class="oswald">ARRASTRA UN ARCHIVO AQU√ç (OPCIONAL)</h3>
                <p class="text-muted">O haz clic para seleccionar una imagen o v√≠deo</p>
                <input type="file" id="fileElem" accept="image/*,video/*" class="d-none">
            </div>

            <div id="preview-container" class="d-none mb-4">
                <h5 class="oswald mb-3">VISTA PREVIA DEL ARCHIVO</h5>
                <img id="preview-img" src="" alt="Preview" class="img-fluid rounded-4 border border-warning shadow-lg d-none">
                <video id="preview-video" controls class="img-fluid rounded-4 border border-warning shadow-lg d-none"></video>
                <div class="text-end mt-2">
                    <button type="button" id="remove-file" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash me-1"></i> Quitar archivo
                    </button>
                </div>
            </div>

            <div id="status" class="alert d-none mb-4"></div>

            <div class="d-grid">
                <button id="send-btn" class="btn btn-gold btn-lg oswald">
                    <i class="bi bi-megaphone-fill me-2"></i>REPARTIR SABIDUR√çA
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const dropArea = document.getElementById('drop-area');
    const fileElem = document.getElementById('fileElem');
    const messageElem = document.getElementById('message');
    const previewContainer = document.getElementById('preview-container');
    const previewImg = document.getElementById('preview-img');
    const previewVideo = document.getElementById('preview-video');
    const removeFileBtn = document.getElementById('remove-file');
    const sendBtn = document.getElementById('send-btn');
    const status = document.getElementById('status');

    let currentFile = null;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('bg-warning-subtle'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('bg-warning-subtle'), false);
    });

    dropArea.addEventListener('drop', handleDrop, false);
    dropArea.addEventListener('click', () => fileElem.click(), false);
    fileElem.addEventListener('change', (e) => handleFiles(e.target.files), false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    function handleFiles(files) {
        const file = files[0];
        if (file) {
            currentFile = file;
            
            previewImg.classList.add('d-none');
            previewVideo.classList.add('d-none');
            previewVideo.src = '';

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    previewImg.classList.remove('d-none');
                    previewContainer.classList.remove('d-none');
                    status.classList.add('d-none');
                };
                reader.readAsDataURL(file);
            } else if (file.type.startsWith('video/')) {
                const url = URL.createObjectURL(file);
                previewVideo.src = url;
                previewVideo.classList.remove('d-none');
                previewContainer.classList.remove('d-none');
                status.classList.add('d-none');
            }
        }
    }

    removeFileBtn.addEventListener('click', () => {
        currentFile = null;
        fileElem.value = '';
        previewImg.src = '';
        previewVideo.src = '';
        previewContainer.classList.add('d-none');
    });

    sendBtn.addEventListener('click', () => {
        const message = messageElem.value.trim();
        if (!currentFile && !message) {
            status.textContent = 'Escribe algo o sube un archivo, alma de c√°ntaro.';
            status.className = 'alert alert-warning mb-4';
            status.classList.remove('d-none');
            return;
        }

        const formData = new FormData();
        if (currentFile) {
            formData.append('data', currentFile);
        }
        formData.append('message', message);

        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ENVIANDO...';
        status.classList.add('d-none');

        fetch('/admin/broadcast', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            status.textContent = data;
            status.className = 'alert alert-success mb-4';
            status.classList.remove('d-none');
            sendBtn.innerHTML = '<i class="bi bi-megaphone-fill me-2"></i>REPARTIR SABIDUR√çA';
            sendBtn.disabled = false;
            
            // Clear on success
            if (!data.includes('Error')) {
                messageElem.value = '';
                removeFileBtn.click();
            }
        })
        .catch(error => {
            status.textContent = 'Error: ' + error;
            status.className = 'alert alert-danger mb-4';
            status.classList.remove('d-none');
            sendBtn.innerHTML = '<i class="bi bi-megaphone-fill me-2"></i>REPARTIR SABIDUR√çA';
            sendBtn.disabled = false;
        });
    });
</script>

<style>
    .bg-warning-subtle {
        background: rgba(255, 193, 7, 0.2) !important;
        border-color: var(--primary-gold) !important;
    }
</style>
{% endblock %}