{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="glass-card p-5 animate__animated animate__fadeIn">
            <h1 class="hero-title oswald mb-4">游닉 BROADCAST MAESTRO</h1>
            <p class="text-muted mb-4">Env칤a sabidur칤a a todos los m치quinas. Puedes mandar solo texto, o una imagen/v칤deo con un mensaje opcional.</p>

            <div class="mb-4">
                <label for="message" class="form-label fw-bold text-warning">Mensaje a difundir</label>
                <textarea class="form-control glass-card bg-transparent text-white border-secondary"
                          id="message" name="message" rows="4"
                          placeholder="Escribe aqu칤 tu sabidur칤a..."></textarea>
            </div>

            <div id="drop-area" class="border border-2 border-dashed border-warning rounded-4 p-5 text-center mb-4"
                 style="cursor: pointer; transition: all 0.3s; background: rgba(255, 193, 7, 0.05);">
                <i class="bi bi-cloud-upload fs-1 text-warning mb-3"></i>
                <h3 class="oswald">ARRASTRA UN ARCHIVO AQU칈 (OPCIONAL)</h3>
                <p class="text-muted">O haz clic para seleccionar una imagen o v칤deo</p>
                <input type="file" id="fileElem" accept="image/*,video/*" class="d-none">
            </div>

            <div id="preview-container" class="d-none mb-4">
                <h5 class="oswald mb-3">VISTA PREVIA DEL ARCHIVO</h5>
                <img id="preview-img" src="" alt="Preview" class="img-fluid rounded-4 border border-warning shadow-lg d-none">
                <video id="preview-video" controls class="img-fluid rounded-4 border border-warning shadow-lg d-none"></video>
                <div class="text-end mt-2">
                    <button type="button" id="remove-file" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash me-1"></i> Quitar archivo
                    </button>
                </div>
            </div>

                        <div id="status" class="alert d-none mb-4"></div>

                        <!-- Progress Bar Section -->
                        <div id="progress-container" class="d-none mb-4 animate__animated animate__fadeIn">
                            <div class="d-flex justify-content-between mb-2">
                                <span id="progress-status" class="text-warning fw-bold small">Iniciando...</span>
                                <span id="progress-percent" class="text-white small">0%</span>
                            </div>
                            <div class="progress bg-dark border border-secondary" style="height: 10px;">
                                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-2 text-center">
                                <small class="text-muted">Procesando a: <span id="current-user" class="text-white">...</span></small>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button id="send-btn" class="btn btn-gold btn-lg oswald">
                                <i class="bi bi-megaphone-fill me-2"></i>REPARTIR SABIDUR칈A
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SSE Connection Target (Hidden) -->
            <div id="sse-handler" hx-ext="sse" class="d-none"></div>
            {% endblock %}

            {% block scripts %}
            <script>
                const dropArea = document.getElementById('drop-area');
                const fileElem = document.getElementById('fileElem');
                const messageElem = document.getElementById('message');
                const previewContainer = document.getElementById('preview-container');
                const previewImg = document.getElementById('preview-img');
                const previewVideo = document.getElementById('preview-video');
                const removeFileBtn = document.getElementById('remove-file');
                const sendBtn = document.getElementById('send-btn');
                const status = document.getElementById('status');

                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const progressStatus = document.getElementById('progress-status');
                const progressPercent = document.getElementById('progress-percent');
                const currentUser = document.getElementById('current-user');
                const sseHandler = document.getElementById('sse-handler');

                let currentFile = null;

                // ... (Keep drag & drop logic same)
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('bg-warning-subtle'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('bg-warning-subtle'), false);
                });

                dropArea.addEventListener('drop', handleDrop, false);
                dropArea.addEventListener('click', () => fileElem.click(), false);
                fileElem.addEventListener('change', (e) => handleFiles(e.target.files), false);

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleFiles(files);
                }

                function handleFiles(files) {
                    const file = files[0];
                    if (file) {
                        currentFile = file;

                        previewImg.classList.add('d-none');
                        previewVideo.classList.add('d-none');
                        previewVideo.src = '';

                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                previewImg.src = e.target.result;
                                previewImg.classList.remove('d-none');
                                previewContainer.classList.remove('d-none');
                                status.classList.add('d-none');
                            };
                            reader.readAsDataURL(file);
                        } else if (file.type.startsWith('video/')) {
                            const url = URL.createObjectURL(file);
                            previewVideo.src = url;
                            previewVideo.classList.remove('d-none');
                            previewContainer.classList.remove('d-none');
                            status.classList.add('d-none');
                        }
                    }
                }

                removeFileBtn.addEventListener('click', () => {
                    currentFile = null;
                    fileElem.value = '';
                    previewImg.src = '';
                    previewVideo.src = '';
                    previewContainer.classList.add('d-none');
                });

                sendBtn.addEventListener('click', () => {
                    const message = messageElem.value.trim();

                    // If there's a file, we use the traditional POST (it won't have real-time progress for now but works)
                    // If it's ONLY text, we'll use the new SSE flow for real-time progress
                    if (currentFile) {
                        sendTraditionalBroadcast(message);
                    } else if (message) {
                        startRealTimeBroadcast(message);
                    } else {
                        status.textContent = 'Escribe algo o sube un archivo, alma de c치ntaro.';
                        status.className = 'alert alert-warning mb-4';
                        status.classList.remove('d-none');
                    }
                });

                function sendTraditionalBroadcast(message) {
                    const formData = new FormData();
                    formData.append('data', currentFile);
                    formData.append('message', message);

                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ENVIANDO ARCHIVO...';
                    status.classList.add('d-none');

                    fetch('/admin/broadcast', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.text())
                    .then(data => {
                        status.textContent = data;
                        status.className = 'alert alert-success mb-4';
                        status.classList.remove('d-none');
                        sendBtn.innerHTML = '<i class="bi bi-megaphone-fill me-2"></i>REPARTIR SABIDUR칈A';
                        sendBtn.disabled = false;

                        messageElem.value = '';
                        removeFileBtn.click();
                    })
                    .catch(error => {
                        status.textContent = 'Error: ' + error;
                        status.className = 'alert alert-danger mb-4';
                        status.classList.remove('d-none');
                        sendBtn.innerHTML = '<i class="bi bi-megaphone-fill me-2"></i>REPARTIR SABIDUR칈A';
                        sendBtn.disabled = false;
                    });
                }

                function startRealTimeBroadcast(message) {
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>PROCESANDO...';
                    status.classList.add('d-none');
                    progressContainer.classList.remove('d-none');

                    // Reset progress bar
                    progressBar.style.width = '0%';
                    progressPercent.textContent = '0%';
                    progressStatus.textContent = 'Iniciando conexi칩n...';
                    currentUser.textContent = '...';

                    // Add SSE listener
                    const sseUrl = `/admin/broadcast/status?message=${encodeURIComponent(message)}`;

                    // Use standard EventSource for easier control than HTMX SSE extension for this specific case
                    const source = new EventSource(sseUrl);

                    source.addEventListener('progress', (event) => {
                        const data = JSON.parse(event.data);

                        progressBar.style.width = data.progress + '%';
                        progressPercent.textContent = data.progress + '%';
                        progressStatus.textContent = data.status;
                        currentUser.textContent = data.current_user;

                        if (data.status.includes('Completado')) {
                            source.close();
                            sendBtn.disabled = false;
                            sendBtn.innerHTML = '<i class="bi bi-megaphone-fill me-2"></i>REPARTIR SABIDUR칈A';
                            messageElem.value = '';

                            status.textContent = data.status;
                            status.className = 'alert alert-success mb-4';
                            status.classList.remove('d-none');
                        }
                    });

                    source.onerror = (err) => {
                        console.error("SSE Error:", err);
                        source.close();
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="bi bi-megaphone-fill me-2"></i>REPARTIR SABIDUR칈A';
                        status.textContent = 'Se perdi칩 la conexi칩n con el servidor, fiera.';
                        status.className = 'alert alert-danger mb-4';
                        status.classList.remove('d-none');
                    };
                }
            </script>
<style>
    .bg-warning-subtle {
        background: rgba(255, 193, 7, 0.2) !important;
        border-color: var(--primary-gold) !important;
    }
</style>
{% endblock %}
