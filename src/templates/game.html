<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paco's Tapas Runner</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Kalam:wght@700&display=swap" rel="stylesheet">
    <style>
                body { margin: 0; padding: 0; background-color: #1a1a1a; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; font-family: 'Kalam', cursive; }
                #game-container { width: 100%; height: 100%; border: 5px solid #4e342e; box-sizing: border-box; position: relative; }
                #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }

                #start-screen {
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('/static/game/baldosa.png');
                    background-size: cover;
                    display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 300; text-align: center; color: white;
                    padding: 10px; box-sizing: border-box;
                }

                .menu-card {
                    background: #222;
                    border: 5px solid #4e342e;
                    padding: 15px;
                    border-radius: 10px;
                    box-shadow: 0 0 20px rgba(0,0,0,0.5);
                    max-width: 100%;
                    width: 350px;
                    position: relative;
                    max-height: 90vh;
                    overflow-y: auto;
                }
                .menu-card::before {
            content: "MEN√ö DEL D√çA";
            display: block;
            font-family: 'Permanent Marker', cursive;
            font-size: 1.5rem;
            color: #FFD700;
            margin-bottom: 10px;
            text-decoration: underline;
        }

        #game-over-screen {
            position: fixed; top: -100%; left: 0; width: 100%; height: 100%;
            background: #333;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 500; text-align: center;
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-bottom: 15px solid #222;
        }

        #game-over-screen.active { top: 0; }

        .btn {
            background: #FFD700; color: #000; padding: 12px 25px; border: 3px solid #4e342e;
            border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 15px;
            font-size: 1.2rem; font-family: 'Permanent Marker', cursive;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        ul li { margin: 3px 0; font-size: 1rem; list-style: none; }
        .price { color: #FFD700; float: right; margin-left: 20px; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <h2>ABRIENDO EL BAR...</h2>
        <p>Sacando los palillos...</p>
    </div>

    <div id="start-screen">
        <div class="menu-card">
            <h1 style="color: #FFD700; font-size: 2.2rem; margin-bottom: 5px; font-family: 'Permanent Marker';">PACO'S TAPAS RUNNER</h1>

            <div id="challenge-banner" style="background: #444; border: 2px dashed #FFD700; padding: 10px; margin-bottom: 15px; border-radius: 5px;">
                <h3 style="margin: 0; color: #FFD700; font-family: 'Permanent Marker'; font-size: 1rem;">üèÜ DESAF√çO DEL D√çA</h3>
                <p id="challenge-text" style="margin: 5px 0 0 0; font-size: 0.9rem;"></p>
            </div>

            <div style="font-size: 0.9rem; line-height: 1.2; margin-bottom: 15px; text-align: left;">
                <p id="high-score-display" style="text-align: center; color: #FFD700; font-weight: bold; margin-bottom: 10px;"></p>
                <ul>
                    <li>‚úÖ Croqueta <span class="price">+10 pts</span></li>
                    <li>üçñ Jam√≥n Ib√©rico <span class="price">+50 pts</span></li>
                    <li>‚òï Carajillo <span class="price">INVENCIBLE</span></li>
                    <li>üç∫ Ca√±ita <span class="price">+10 SEG</span></li>
                    <li>üßª Servilleta <span class="price">+1 VIDA</span></li>
                    <li>ü•ë Aguacate <span class="price">-1 VIDA</span></li>
                    <li>üç£ Sushi Moderno <span class="price">-1 VIDA</span></li>
                    <li>üí∏ La Cuenta <span class="price">-50 pts</span></li>
                </ul>
                <p style="text-align: center; margin-top: 10px; font-style: italic;">¬°Pincha lo bueno con el palillo!</p>
            </div>
            <button id="start-btn" class="btn">¬°O√çDO COCINA!</button>
        </div>
    </div>

    <div id="game-over-screen">
        <h1 style="color: #ff0000; font-size: 3.5rem; font-family: 'Permanent Marker'; text-shadow: 2px 2px #000;">¬°LA CUENTA!</h1>
        <h2 id="final-score-text" style="font-size: 2rem;">Puntuaci√≥n: 0</h2>
        <p id="status-text">Cerrando el bar...</p>
        <button class="btn" onclick="window.location.reload()">¬øOTRA RONDA?</button>
        {% if not is_web %}
        <button class="btn" style="background: #0088cc; color: #FFF;" onclick="shareScore()">DAR ENVIDIA</button>
        {% endif %}
        <a href="/game/ranking" class="btn" style="background: #444; color: #FFF; text-decoration: none; display: inline-block;">RANKING</a>
    </div>

    <div id="game-container"></div>

    <script type="module">
        const USER_ID = "{{ user_id }}";
        const INLINE_MESSAGE_ID = "{{ inline_message_id or '' }}";
        const CHAT_ID = "{{ chat_id or '' }}";
        const MESSAGE_ID = "{{ message_id or '' }}";
        const SECRET = "{{ secret }}";
        const GREETING_AUDIO_URL = "{{ greeting_audio_url }}";
        const GAME_OVER_AUDIO_URL = "{{ game_over_audio_url }}";
        const DAILY_CHALLENGE = {{ daily_challenge_json | safe }};
        const SERVER_HIGH_SCORE = {{ high_score or 0 }};

        // Local high score management
        const localHigh = localStorage.getItem('paco_high_score') || 0;
        const currentHigh = Math.max(SERVER_HIGH_SCORE, localHigh);
        if (currentHigh > localHigh) localStorage.setItem('paco_high_score', currentHigh);

        // Exponer shareScore al √°mbito global cumpliendo con la API de Telegram Games
        window.shareScore = function() {
            console.log("Intentando compartir puntuaci√≥n v√≠a TelegramGameProxy...");
            if (typeof TelegramGameProxy !== 'undefined') {
                TelegramGameProxy.shareScore();
            } else if (window.Telegram && window.Telegram.GameProxy) {
                window.Telegram.GameProxy.shareScore();
            } else {
                console.error("TelegramGameProxy no encontrado");
                alert("Para compartir tu puntuaci√≥n, debes jugar desde la app de Telegram.");
            }
        };

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            parent: 'game-container',
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
            scene: { preload: preload, create: create, update: update }
        };

        const game = new Phaser.Game(config);
        let player, items, background, bar, score = 0, lives = 3, scoreText, livesText, waveText, gameActive = false, isInvincible = false, timeLeft = 45;
        let invincibilityTime = 0;
        let comboCount = 0;
        let spawnEvent, timerEvent, waveEvent;
        let currentWave = 'normal'; // 'normal', 'invitation', 'modern'
        let lastWave = 'normal';
        let emitterCrumbs, emitterSparks, emitterSplat;
        let bgm;
        let lifeIcons = [];
        let beerTimer, beerBg, invincibilityBar;
        const INITIAL_TIME = 45;

        function preload() {
            // Load assets
            this.load.image('palillo', '/static/game/palillo.png?v=2');
            this.load.image('croqueta', '/static/game/croqueta.png?v=2');
            this.load.image('aguacate', '/static/game/aguacate.png?v=2');
            this.load.image('carajillo', '/static/game/carajillo.png?v=2');
            this.load.image('jamon', '/static/game/jamon.png?v=2');
            this.load.image('sushi', '/static/game/sushi.png?v=2');
            this.load.image('factura', '/static/game/factura.png?v=2');
            this.load.image('baldosa', '/static/game/baldosa.png?v=2');
            this.load.image('barra', '/static/game/barra.png?v=2');
            this.load.image('servilleta', '/static/game/servilleta.png?v=2');
            this.load.image('canita', '/static/game/cerveza.png');

            // Audio
            this.load.audio('bgm', '/static/game/bgm.mp3');
            this.load.audio('crunch', '/static/game/crunch.wav');
            this.load.audio('hurt', '/static/game/hurt.mp3');
            this.load.audio('powerup', '/static/game/powerup.mp3');
            this.load.audio('cash', '/static/game/cash.mp3');

            // Create simple particle textures
            const graphics = this.make.graphics({x: 0, y: 0, add: false});

            // Gold crumb
            graphics.fillStyle(0xFFD700, 1);
            graphics.fillRect(0, 0, 4, 4);
            graphics.generateTexture('crumb', 4, 4);
            graphics.clear();

            // Purple/Magic spark
            graphics.fillStyle(0xFF00FF, 1);
            graphics.fillCircle(4, 4, 4);
            graphics.generateTexture('spark', 8, 8);
            graphics.clear();

            // Green splat
            graphics.fillStyle(0x00FF00, 1);
            graphics.fillCircle(5, 5, 5);
            graphics.generateTexture('splat', 10, 10);
            graphics.clear();
        }

        function create() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';

            // Setup Challenge Text
            const challengeText = document.getElementById('challenge-text');
            if (DAILY_CHALLENGE.multiplier > 1) {
                challengeText.innerText = `¬°Hoy las ${DAILY_CHALLENGE.name}s dan PUNTOS DOBLES!`;
            } else if (DAILY_CHALLENGE.multiplier === 0) {
                challengeText.innerText = `¬°Hoy el ${DAILY_CHALLENGE.name} NO quita vidas y da +25 pts!`;
            } else {
                challengeText.innerText = `¬°Hoy la ${DAILY_CHALLENGE.name} solo te quita la mitad!`;
            }

            // Setup High Score Display
            document.getElementById('high-score-display').innerText = `‚≠ê R√©cord Personal: ${currentHigh} pts`;

            if (USER_ID === 'guest') {
                 const warning = document.createElement('div');
                 warning.style.color = '#FFA500';
                 warning.style.marginTop = '10px';
                 warning.style.fontSize = '0.9rem';
                 warning.innerText = '‚ö†Ô∏è Modo invitado: La puntuaci√≥n no se guardar√° en el ranking global.';
                 document.querySelector('#start-screen > div').appendChild(warning);
            }

            background = this.add.tileSprite(config.width / 2, config.height / 2, config.width, config.height, 'baldosa');
            background.setTileScale(0.5, 0.5);

            bar = this.add.tileSprite(config.width / 2, config.height - 20, config.width, 40, 'barra');
            bar.setTileScale(0.5, 0.5);
            this.physics.add.existing(bar, true);

            // Player
            player = this.physics.add.sprite(config.width / 2, config.height - 100, 'palillo');
            player.setCollideWorldBounds(true);
            player.setScale(0.12);
            player.angle = 180;
            // Narrow hitbox for the toothpick
            player.body.setSize(player.width * 0.15, player.height * 0.85);
            player.body.setOffset(player.width * 0.425, player.height * 0.05);

            items = this.physics.add.group();

            // Particle Managers
            emitterCrumbs = this.add.particles(0, 0, 'crumb', {
                speed: { min: 100, max: 200 },
                angle: { min: 0, max: 360 },
                scale: { start: 1, end: 0 },
                lifespan: 500,
                quantity: 10,
                emitting: false
            });

            emitterSparks = this.add.particles(0, 0, 'spark', {
                speed: { min: 50, max: 150 },
                scale: { start: 1, end: 0 },
                lifespan: 800,
                blendMode: 'ADD',
                quantity: 15,
                emitting: false
            });

            emitterSplat = this.add.particles(0, 0, 'splat', {
                speed: 100,
                lifespan: 600,
                gravityY: 300,
                quantity: 20,
                emitting: false,
                tint: [0x00ff00, 0x008800]
            });

                        // HUD: Chalkboard Style

                        const isSmallScreen = config.width < 400;

                        scoreText = this.add.text(20, 20, 'PUNTOS: 0', {

                            fontSize: isSmallScreen ? '24px' : '32px',

                            fill: '#FFD700',

                            fontFamily: 'Permanent Marker',

                            stroke: '#000',

                            strokeThickness: 2

                        });



                        // Beer Timer Visual (Positioned relative to right edge)

                        const timerX = config.width - (isSmallScreen ? 60 : 80);

                        this.add.text(config.width - (isSmallScreen ? 110 : 150), 20, 'TIEMPO', {

                            fontSize: isSmallScreen ? '14px' : '18px',

                            fill: '#FFF',

                            fontFamily: 'Permanent Marker'

                        });



                        // Empty glass background

                        beerBg = this.add.image(timerX, 110, 'canita').setScale(0.3).setAlpha(0.2).setTint(0x000000);

                        // Full beer that will be cropped

                        beerTimer = this.add.image(timerX, 110, 'canita').setScale(0.3);



                        // Napkin Lives

                        for(let i=0; i<3; i++) {

                            let icon = this.add.image(40 + (i * 45), 80, 'servilleta').setScale(0.08);

                            lifeIcons.push(icon);

                        }



            waveText = this.add.text(20, 115, '', {
                fontSize: '20px',
                fill: '#FFF',
                fontFamily: 'Permanent Marker',
                backgroundColor: 'rgba(0,0,0,0.5)',
                padding: { x: 10, y: 5 }
            });
            waveText.setAlpha(0);

            invincibilityBar = this.add.graphics();

            updateLivesDisplay.call(this);

            // Squash & Stretch Logic
            this.input.on('pointermove', (pointer) => {
                if (gameActive) {
                    const diffX = pointer.x - player.x;
                    player.x = pointer.x;

                    // Simple tilt based on movement speed
                    const targetAngle = 180 - Phaser.Math.Clamp(diffX * 0.5, -20, 20);
                    player.setAngle(targetAngle);
                }
            });

            this.physics.add.overlap(player, items, handleCollision, null, this);

            document.getElementById('start-btn').addEventListener('click', () => {
                document.getElementById('start-screen').style.display = 'none';
                gameActive = true;
                startTimers.call(this);

                // Play Music
                bgm = this.sound.add('bgm', { loop: true, volume: 0.5 });
                bgm.play();

                if (GREETING_AUDIO_URL) {
                    const audio = new Audio(GREETING_AUDIO_URL);
                    audio.play().catch(e => console.log("Audio play failed", e));
                }
            });
        }

        function startTimers() {
            spawnEvent = this.time.addEvent({ delay: 600, callback: spawnRandomItem, callbackScope: this, loop: true });

            // Wave Manager: Switches wave type every 10 seconds
            waveEvent = this.time.addEvent({
                delay: 10000,
                callback: () => {
                    if (!gameActive) return;

                    let nextWave;
                    const rand = Math.random();

                    if (currentWave !== 'normal') {
                        // Always go back to normal after a special wave to let the player breathe
                        nextWave = 'normal';
                    } else {
                        // If we are in normal, 50% chance to stay normal, 50% to start a special one
                        if (rand < 0.5) {
                            nextWave = 'normal';
                        } else {
                            // Pick a special wave different from the last special one we had
                            nextWave = (lastWave === 'invitation') ? 'modern' : 'invitation';
                        }
                    }

                    if (nextWave !== 'normal') lastWave = nextWave;
                    currentWave = nextWave;

                    let msg = "MODO NORMAL";
                    let color = "#FFFFFF";
                    let displayMsg = "";

                    if (currentWave === 'invitation') {
                        msg = "¬°RONDA DE INVITACI√ìN!";
                        displayMsg = "üì¢ RONDA DE INVITACI√ìN";
                        color = "#FFD700";
                        spawnEvent.delay = 350; // Slightly slower than before
                    } else if (currentWave === 'modern') {
                        msg = "¬°ATAQUE MODERNO!";
                        displayMsg = "ü•ë ATAQUE MODERNO";
                        color = "#00FF00";
                        spawnEvent.delay = 1500; // Slower rows to make it fair
                    } else {
                        spawnEvent.delay = 600;
                    }

                    waveText.setText(displayMsg);
                    waveText.setFill(color);
                    waveText.setAlpha(displayMsg ? 1 : 0);
                    showFloatingText.call(this, config.width / 2, 150, msg, color);
                },
                callbackScope: this, loop: true
            });

            timerEvent = this.time.addEvent({
                delay: 1000,
                callback: () => {
                    if (!gameActive) return;
                    timeLeft--;
                    if (timeLeft <= 0) gameOver.call(this, score);
                },
                callbackScope: this, loop: true
            });
        }

        function spawnRandomItem() {
            if (!gameActive) return;

            if (currentWave === 'invitation') {
                // Mostly good things, but allow occasional beer/napkin
                const r = Math.random();
                if (r < 0.7) spawnItem.call(this, Phaser.Math.Between(40, config.width - 40), 'croqueta');
                else if (r < 0.9) spawnItem.call(this, Phaser.Math.Between(40, config.width - 40), 'jamon');
                else spawnItem.call(this, Phaser.Math.Between(40, config.width - 40), Math.random() < 0.5 ? 'canita' : 'servilleta');
                return;
            }

            if (currentWave === 'modern') {
                // Spawn a row with a gap
                const gap = Phaser.Math.Between(0, 4);
                const colWidth = config.width / 5;
                for (let i = 0; i < 5; i++) {
                    if (i !== gap) {
                        spawnItem.call(this, (i * colWidth) + (colWidth / 2), Math.random() < 0.5 ? 'aguacate' : 'sushi');
                    } else {
                        // The gap can contain anything from the normal mode! (Beer, napkins, etc)
                        const rand = Math.random();
                        if (rand < 0.2) {
                             // Pick a random normal item for the gap
                             const type = getNormalItemType();
                             spawnItem.call(this, (i * colWidth) + (colWidth / 2), type);
                        }
                    }
                }
                return;
            }

            // Normal spawning
            spawnItem.call(this, Phaser.Math.Between(40, config.width - 40), getNormalItemType());
        }

        function getNormalItemType() {
            const rand = Math.random();
            if (rand < 0.45) return 'croqueta';
            if (rand < 0.65) return 'aguacate';
            if (rand < 0.75) return 'sushi';
            if (rand < 0.82) return 'factura';
            if (rand < 0.88) return 'jamon';
            if (rand < 0.93) return 'carajillo';
            if (rand < 0.97) return 'canita'; // Time boost

            // Servilleta logic (only if needed)
            if (lives < 3) return 'servilleta';
            return 'croqueta';
        }

        function spawnItem(x, type) {
            const item = items.create(x, -50, type);
            item.setData('type', type);

            if (type === 'canita') item.setScale(0.12);
            else item.setScale(0.08);

            item.setCircle(item.width / 2.2);

            // Random initial rotation and angular velocity for swaying
            item.setAngle(Phaser.Math.Between(0, 360));
            item.setAngularVelocity(Phaser.Math.Between(-100, 100));

            const speed = 250 + (score / 3);
            if (type === 'jamon') item.setVelocityY(speed * 1.5);
            else if (type === 'factura') item.setVelocityY(speed * 0.8);
            else if (type === 'servilleta' || type === 'canita') item.setVelocityY(speed * 0.7);
            else item.setVelocityY(speed);

            // Add a sway tween
            this.tweens.add({
                targets: item,
                x: item.x + Phaser.Math.Between(-30, 30),
                duration: 1000 + Phaser.Math.Between(-200, 200),
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
        }

                function handleCollision(player, item) {

                    const type = item.getData('type');

                    const itemX = item.x;

                    const itemY = item.y;

                    item.destroy();



                    // FX: Screen Shake

                    this.cameras.main.shake(50, 0.005);



                    // UI Feedback: Score Pop

                    this.tweens.add({

                        targets: scoreText,

                        scale: { from: 1.5, to: 1 },

                        duration: 200,

                        ease: 'Back.out'

                    });



                    // Special Challenge Logic

                    let challengeBonus = 1;

                    if (type === DAILY_CHALLENGE.type) {

                        if (DAILY_CHALLENGE.multiplier > 1) {

                            challengeBonus = DAILY_CHALLENGE.multiplier;

                            showFloatingText.call(this, player.x, player.y - 40, '¬°DESAF√çO x2!', '#FFD700');

                        } else if (DAILY_CHALLENGE.multiplier === 0) {

                            // Modern food becomes good

                            score += 25;

                            this.sound.play('crunch');

                            showFloatingText.call(this, player.x, player.y, '¬°DESAF√çO! +25', '#00FF00');

                            emitterCrumbs.emitParticleAt(itemX, itemY);

                            scoreText.setText('PUNTOS: ' + score);

                            return;

                        } else if (DAILY_CHALLENGE.multiplier === -0.5) {

                            // Factura hurts less

                            score = Math.max(0, score - 25);

                            this.sound.play('cash');

                            showFloatingText.call(this, player.x, player.y, '¬°DESAF√çO! -25', '#888888');

                            scoreText.setText('PUNTOS: ' + score);

                            return;

                        }

                    }



                    if (type === 'croqueta') {

                        comboCount++;

                        let multiplier = 1 * challengeBonus;

                        let comboMsg = `+${10 * multiplier}`;



                        if (comboCount >= 3) {

                            multiplier *= 2;

                            comboMsg = `¬°FIERA! x${multiplier}`;

                        }

                        if (comboCount >= 6) {

                            multiplier *= 3;

                            comboMsg = `¬°NIVEL DIOS! x${multiplier}`;

                        }



                        score += 10 * multiplier;

                        this.sound.play('crunch');

                        showFloatingText.call(this, player.x, player.y, comboMsg, '#FFD700');

                        emitterCrumbs.emitParticleAt(itemX, itemY);

                    } else if (type === 'jamon') {

                        comboCount++;

                        score += 50 * challengeBonus;

                        this.sound.play('crunch');

                        showFloatingText.call(this, player.x, player.y, `¬°IB√âRICO! +${50 * challengeBonus}`, '#FF0000');

                        emitterCrumbs.emitParticleAt(itemX, itemY, 20); // More particles



                        // Slow motion FX

                        this.time.timeScale = 0.5;

                        this.time.delayedCall(500, () => { this.time.timeScale = 1.0; });

                    } else if (type === 'aguacate' || type === 'sushi') {


                comboCount = 0;
                if (!isInvincible) {
                    lives--;
                    updateLivesDisplay.call(this);
                    this.sound.play('hurt');

                    // Bad collision FX: Intense shake and flash
                    this.cameras.main.shake(300, 0.02);
                    this.cameras.main.flash(200, 255, 0, 0); // Red flash
                    if (navigator.vibrate) navigator.vibrate(200); // Vibrate
                    emitterSplat.emitParticleAt(itemX, itemY);

                    showFloatingText.call(this, player.x, player.y, '¬°VETE A UN STARBUCKS!', '#00FF00');
                    if (lives <= 0) gameOver.call(this, score);
                } else {
                    score += 25;
                    this.sound.play('crunch');
                    showFloatingText.call(this, player.x, player.y, '¬°CRUNCH!', '#FFFF00');
                    emitterCrumbs.emitParticleAt(itemX, itemY);
                }
            } else if (type === 'factura') {
                 comboCount = 0;
                 if (!isInvincible) {
                    score = Math.max(0, score - 50);
                    this.sound.play('cash');
                    showFloatingText.call(this, player.x, player.y, '¬°DOLOROSA! -50', '#888888');
                    this.cameras.main.flash(100, 200, 200, 200);
                    this.cameras.main.shake(100, 0.01);
                 }
            } else if (type === 'carajillo') {
                isInvincible = true;
                invincibilityTime = 6000;
                this.sound.play('powerup');
                player.setTint(0xFFD700);
                player.setScale(0.15);
                emitterSparks.emitParticleAt(itemX, itemY, 30);
                showFloatingText.call(this, player.x, player.y, '¬°O√çDO COCINA!', '#FFFFFF');
            } else if (type === 'servilleta') {
                if (lives < 3) {
                    lives++;
                    updateLivesDisplay.call(this);
                    this.sound.play('powerup');
                    showFloatingText.call(this, player.x, player.y, '+1 VIDA', '#FFFFFF');
                    emitterSparks.emitParticleAt(itemX, itemY, 20);
                } else {
                    score += 100;
                    showFloatingText.call(this, player.x, player.y, 'LIMPIEZA +100', '#FFFFFF');
                }
            } else if (type === 'canita') {
                timeLeft += 10;
                this.sound.play('powerup');
                showFloatingText.call(this, player.x, player.y, '+10 SEGUNDOS', '#DAA520');
                emitterSparks.emitParticleAt(itemX, itemY, 20);

                // Visual feedback for timer
                this.tweens.add({
                    targets: [beerTimer, beerBg],
                    scale: { from: 0.4, to: 0.3 },
                    duration: 300,
                    ease: 'Back.out'
                });
            }
            scoreText.setText('PUNTOS: ' + score);
        }

        function showFloatingText(x, y, message, color) {
            let text = this.add.text(x, y - 20, message, { fontSize: '24px', fontFamily: 'Permanent Marker', fill: color, stroke: '#000', strokeThickness: 3 });
            this.tweens.add({
                targets: text,
                y: y - 120,
                alpha: 0,
                duration: 2000,
                ease: 'Power2',
                onComplete: () => text.destroy()
            });
        }

        function updateLivesDisplay() {
            lifeIcons.forEach((icon, i) => {
                const shouldBeVisible = i < lives;
                if (shouldBeVisible && !icon.visible) {
                    // Just gained this life
                    icon.visible = true;
                    icon.alpha = 0;
                    icon.scale = 0.2;
                    this.tweens.add({
                        targets: icon,
                        alpha: 1,
                        scale: 0.08,
                        duration: 400,
                        ease: 'Back.out'
                    });
                } else if (!shouldBeVisible && icon.visible) {
                    // Just lost this life
                    this.tweens.add({
                        targets: icon,
                        scale: 0.2,
                        alpha: 0,
                        duration: 200,
                        onComplete: () => { icon.visible = false; }
                    });
                }
            });
        }

        function updateTimerVisual() {
            if (!beerTimer) return;
            const ratio = Math.max(0, timeLeft / INITIAL_TIME);

            // Apply crop: x, y, width, height (in local coordinates of the image)
            // As ratio goes down, we start cropping from the top
            const cropHeight = beerTimer.height * ratio;
            const yOffset = beerTimer.height * (1 - ratio);
            beerTimer.setCrop(0, yOffset, beerTimer.width, cropHeight);

            beerTimer.setTint(ratio < 0.3 ? 0xff0000 : 0xffffff);
        }

        function update(time, delta) {
            background.tilePositionY -= 1;
            updateTimerVisual();

            // Handle Invincibility Bar & Logic
            invincibilityBar.clear();
            if (isInvincible && invincibilityTime > 0) {
                invincibilityTime -= delta;

                const ratio = invincibilityTime / 6000;
                const barWidth = 60;
                const barHeight = 6;
                const x = player.x - barWidth / 2;
                const y = player.y - 60;

                // Border
                invincibilityBar.fillStyle(0x000000, 0.5);
                invincibilityBar.fillRect(x - 2, y - 2, barWidth + 4, barHeight + 4);

                // Progress
                invincibilityBar.fillStyle(0xFFD700, 1);
                invincibilityBar.fillRect(x, y, barWidth * ratio, barHeight);

                // Pulse effect while invincible
                player.setAlpha(0.7 + Math.sin(time / 100) * 0.3);

                if (invincibilityTime <= 0) {
                    isInvincible = false;
                    player.clearTint();
                    player.setScale(0.12);
                    player.setAlpha(1);
                }
            }

            items.children.iterate(child => {
                if (child && child.y > config.height + 50) child.destroy();
            });
        }

        async function getHash(message) {
            if (window.crypto && crypto.subtle) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            } else {
                return "unsafe-" + btoa(message);
            }
        }

        async function gameOver(finalScore) {
            if (!gameActive) return;
            gameActive = false;

            if (spawnEvent) spawnEvent.remove();
            if (timerEvent) timerEvent.remove();

            if (bgm) bgm.stop();

            if (GAME_OVER_AUDIO_URL) {
                const audio = new Audio(GAME_OVER_AUDIO_URL);
                audio.play().catch(e => console.log("Game over audio play failed", e));
            }

            this.physics.pause();
            player.setTint(0xff0000);

            const screen = document.getElementById('game-over-screen');
            const scoreDisplay = document.getElementById('final-score-text');
            const statusDisplay = document.getElementById('status-text');
            scoreDisplay.innerText = "Puntuaci√≥n: " + finalScore;

            // Trigger shutter effect
            screen.classList.add('active');

            // Save high score locally
            if (finalScore > currentHigh) {
                localStorage.setItem('paco_high_score', finalScore);
            }

            const hash = await getHash(`${USER_ID}${finalScore}${SECRET}`);
            try {
                const response = await fetch('/game/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        score: finalScore,
                        inline_message_id: INLINE_MESSAGE_ID,
                        chat_id: CHAT_ID,
                        message_id: MESSAGE_ID,
                        hash: hash
                    })
                });
                if (response.ok) statusDisplay.innerText = "¬°Puntos guardados en el ranking!";
                else statusDisplay.innerText = "Puntos no guardados (Error de servidor)";
            } catch (e) {
                console.error("Score submission error", e);
                statusDisplay.innerText = "Error de conexi√≥n al guardar puntos.";
            }
        }
    </script>
    <script src="https://telegram.org/js/games.js"></script>
</body>
</html>
