<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paco's Tapas Runner</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #1a1a1a; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #game-container { width: 100%; height: 100%; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 300; text-align: center; color: white; }
        #game-over-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 200; text-align: center; }
        .btn { background: #FFD700; color: #000; padding: 15px 30px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 20px; font-size: 1.2rem; }
        ul li { margin: 5px 0; font-size: 1.1rem; }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <h2>ABRIENDO EL BAR...</h2>
        <p>Sacando los palillos...</p>
    </div>

    <div id="start-screen">
        <h1 style="color: #FFD700; font-size: 2.5rem; margin-bottom: 10px;">PACO'S TAPAS RUNNER</h1>
        <div style="font-size: 1rem; max-width: 90%; line-height: 1.4; margin-bottom: 20px; text-align: left;">
            <p style="text-align: center;">üá™üá∏ ¬°Bienvenido a la barra, fiera!</p>
            <ul style="list-style-type: none; padding: 0;">
                <li>‚úÖ <b>Croqueta (+10):</b> Cl√°sico b√°sico.</li>
                <li>üçñ <b>Jam√≥n (+50):</b> Delicatessen pura.</li>
                <li>‚òï <b>Carajillo:</b> Te hace invencible.</li>
                <li>ü•ë <b>Aguacate (-1 Vida):</b> ¬°Comida de modernos!</li>
                <li>üç£ <b>Sushi (-1 Vida):</b> ¬°Aqu√≠ se usa tenedor!</li>
                <li>üí∏ <b>Factura (-50):</b> La dolorosa...</li>
            </ul>
            <p style="text-align: center; margin-top: 15px;">Mueve el palillo para pinchar lo bueno.</p>
        </div>
        <button id="start-btn" class="btn">¬°O√çDO COCINA!</button>
    </div>

    <div id="game-over-screen">
        <h1 style="color: #ff0000; font-size: 3rem;">¬°LA CUENTA!</h1>
        <h2 id="final-score-text">Puntuaci√≥n: 0</h2>
        <p id="status-text">Guardando puntos en la barra...</p>
        <button class="btn" onclick="window.location.reload()">JUGAR OTRA VEZ</button>
        {% if not is_web %}
        <button class="btn" style="background: #0088cc; color: #FFF; margin-top: 10px;" onclick="shareScore()">COMPARTIR PUNTUACI√ìN</button>
        {% endif %}
        <a href="/game/ranking" class="btn" style="background: #444; color: #FFF; text-decoration: none; margin-top: 15px; display: inline-block;">VER RANKING GLOBAL</a>
    </div>

    <div id="game-container"></div>

    <script type="module">
        const USER_ID = "{{ user_id }}";
        const INLINE_MESSAGE_ID = "{{ inline_message_id or '' }}";
        const CHAT_ID = "{{ chat_id or '' }}";
        const MESSAGE_ID = "{{ message_id or '' }}";
        const SECRET = "{{ secret }}";
        const GREETING_AUDIO_URL = "{{ greeting_audio_url }}";
        const GAME_OVER_AUDIO_URL = "{{ game_over_audio_url }}";

        // Exponer shareScore al √°mbito global cumpliendo con la API de Telegram Games
        window.shareScore = function() {
            console.log("Intentando compartir puntuaci√≥n v√≠a TelegramGameProxy...");
            if (typeof TelegramGameProxy !== 'undefined') {
                TelegramGameProxy.shareScore();
            } else if (window.Telegram && window.Telegram.GameProxy) {
                window.Telegram.GameProxy.shareScore();
            } else {
                console.error("TelegramGameProxy no encontrado");
                alert("Para compartir tu puntuaci√≥n, debes jugar desde la app de Telegram.");
            }
        };

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            parent: 'game-container',
            physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
            scene: { preload: preload, create: create, update: update }
        };

        const game = new Phaser.Game(config);
        let player, items, background, bar, score = 0, lives = 3, scoreText, livesText, timerText, gameActive = false, isInvincible = false, timeLeft = 45;
        let spawnEvent, timerEvent;
        let emitterCrumbs, emitterSparks, emitterSplat;
        let bgm;

        function preload() {
            // Load assets
            this.load.image('palillo', '/static/game/palillo.png?v=2');
            this.load.image('croqueta', '/static/game/croqueta.png?v=2');
            this.load.image('aguacate', '/static/game/aguacate.png?v=2');
            this.load.image('carajillo', '/static/game/carajillo.png?v=2');
            this.load.image('jamon', '/static/game/jamon.png?v=2');
            this.load.image('sushi', '/static/game/sushi.png?v=2');
            this.load.image('factura', '/static/game/factura.png?v=2');
            this.load.image('baldosa', '/static/game/baldosa.png?v=2');
            this.load.image('barra', '/static/game/barra.png?v=2');
            this.load.image('servilleta', '/static/game/servilleta.png?v=2');

            // Audio
            this.load.audio('bgm', '/static/game/bgm.mp3');

            // Create simple particle textures
            const graphics = this.make.graphics({x: 0, y: 0, add: false});

            // Gold crumb
            graphics.fillStyle(0xFFD700, 1);
            graphics.fillRect(0, 0, 4, 4);
            graphics.generateTexture('crumb', 4, 4);
            graphics.clear();

            // Purple/Magic spark
            graphics.fillStyle(0xFF00FF, 1);
            graphics.fillCircle(4, 4, 4);
            graphics.generateTexture('spark', 8, 8);
            graphics.clear();

            // Green splat
            graphics.fillStyle(0x00FF00, 1);
            graphics.fillCircle(5, 5, 5);
            graphics.generateTexture('splat', 10, 10);
            graphics.clear();
        }

        function create() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';

            if (USER_ID === 'guest') {
                 const warning = document.createElement('div');
                 warning.style.color = '#FFA500';
                 warning.style.marginTop = '10px';
                 warning.style.fontSize = '0.9rem';
                 warning.innerText = '‚ö†Ô∏è Modo invitado: La puntuaci√≥n no se guardar√° en el ranking global.';
                 document.querySelector('#start-screen > div').appendChild(warning);
            }

            background = this.add.tileSprite(config.width / 2, config.height / 2, config.width, config.height, 'baldosa');
            background.setTileScale(0.5, 0.5);

            bar = this.add.tileSprite(config.width / 2, config.height - 20, config.width, 40, 'barra');
            bar.setTileScale(0.5, 0.5);
            this.physics.add.existing(bar, true);

            // Player
            player = this.physics.add.sprite(config.width / 2, config.height - 100, 'palillo');
            player.setCollideWorldBounds(true);
            player.setScale(0.12);
            player.angle = 180;
            // Narrow hitbox for the toothpick
            player.body.setSize(player.width * 0.15, player.height * 0.85);
            player.body.setOffset(player.width * 0.425, player.height * 0.05);

            items = this.physics.add.group();

            // Particle Managers
            emitterCrumbs = this.add.particles(0, 0, 'crumb', {
                speed: { min: 100, max: 200 },
                angle: { min: 0, max: 360 },
                scale: { start: 1, end: 0 },
                lifespan: 500,
                quantity: 10,
                emitting: false
            });

            emitterSparks = this.add.particles(0, 0, 'spark', {
                speed: { min: 50, max: 150 },
                scale: { start: 1, end: 0 },
                lifespan: 800,
                blendMode: 'ADD',
                quantity: 15,
                emitting: false
            });

            emitterSplat = this.add.particles(0, 0, 'splat', {
                speed: 100,
                lifespan: 600,
                gravityY: 300,
                quantity: 20,
                emitting: false,
                tint: [0x00ff00, 0x008800]
            });

            scoreText = this.add.text(20, 20, 'CU√ëADISMO: 0', { fontSize: '24px', fontWeight: 'bold', fill: '#FFD700', stroke: '#000', strokeThickness: 4, fontFamily: 'Segoe UI' });
            livesText = this.add.text(20, 60, 'SERVILLETAS: 3', { fontSize: '20px', fill: '#FFF', stroke: '#000', strokeThickness: 3 });
            timerText = this.add.text(config.width - 180, 20, 'TIEMPO: ' + timeLeft, { fontSize: '24px', fill: '#FFF', stroke: '#000', strokeThickness: 3 });

            updateLivesDisplay.call(this);

            // Squash & Stretch Logic
            this.input.on('pointermove', (pointer) => {
                if (gameActive) {
                    const diffX = pointer.x - player.x;
                    player.x = pointer.x;

                    // Simple tilt based on movement speed
                    const targetAngle = 180 - Phaser.Math.Clamp(diffX * 0.5, -20, 20);
                    player.setAngle(targetAngle);
                }
            });

            this.physics.add.overlap(player, items, handleCollision, null, this);

            document.getElementById('start-btn').addEventListener('click', () => {
                document.getElementById('start-screen').style.display = 'none';
                gameActive = true;
                startTimers.call(this);

                // Play Music
                bgm = this.sound.add('bgm', { loop: true, volume: 0.5 });
                bgm.play();

                if (GREETING_AUDIO_URL) {
                    const audio = new Audio(GREETING_AUDIO_URL);
                    audio.play().catch(e => console.log("Audio play failed", e));
                }
            });
        }

        function startTimers() {
            spawnEvent = this.time.addEvent({ delay: 600, callback: spawnRandomItem, callbackScope: this, loop: true });
            timerEvent = this.time.addEvent({
                delay: 1000,
                callback: () => {
                    if (!gameActive) return;
                    timeLeft--;
                    timerText.setText('TIEMPO: ' + timeLeft);
                    if (timeLeft <= 0) gameOver.call(this, score);
                },
                callbackScope: this, loop: true
            });
        }

        function spawnRandomItem() {
            if (!gameActive) return;
            const x = Phaser.Math.Between(40, config.width - 40);
            const rand = Math.random();
            let type;

            if (rand < 0.50) type = 'croqueta';
            else if (rand < 0.75) type = 'aguacate';
            else if (rand < 0.85) type = 'sushi';
            else if (rand < 0.92) type = 'factura';
            else if (rand < 0.98) type = 'jamon';
            else type = 'carajillo';

            const item = items.create(x, -50, type);
            item.setData('type', type);
            item.setScale(0.08);
            item.setCircle(item.width / 2.2);

            // Random initial rotation and angular velocity for swaying
            item.setAngle(Phaser.Math.Between(0, 360));
            item.setAngularVelocity(Phaser.Math.Between(-100, 100));

            const speed = 250 + (score / 3);
            if (type === 'jamon') item.setVelocityY(speed * 1.5);
            else if (type === 'factura') item.setVelocityY(speed * 0.8);
            else item.setVelocityY(speed);

            // Add a sway tween
            this.tweens.add({
                targets: item,
                x: item.x + Phaser.Math.Between(-30, 30),
                duration: 1000 + Phaser.Math.Between(-200, 200),
                yoyo: true,
                repeat: -1,
                ease: 'Sine.easeInOut'
            });
        }

        function handleCollision(player, item) {
            const type = item.getData('type');
            const itemX = item.x;
            const itemY = item.y;
            item.destroy();

            // FX: Screen Shake
            this.cameras.main.shake(50, 0.005);

            // UI Feedback: Score Pop
            this.tweens.add({
                targets: scoreText,
                scale: { from: 1.5, to: 1 },
                duration: 200,
                ease: 'Back.out'
            });

            if (type === 'croqueta') {
                score += 10;
                showFloatingText.call(this, player.x, player.y, '+10', '#FFD700');
                emitterCrumbs.emitParticleAt(itemX, itemY);
            } else if (type === 'jamon') {
                score += 50;
                showFloatingText.call(this, player.x, player.y, '¬°IB√âRICO! +50', '#FF0000');
                emitterCrumbs.emitParticleAt(itemX, itemY, 20); // More particles
            } else if (type === 'aguacate' || type === 'sushi') {
                if (!isInvincible) {
                    lives--;
                    updateLivesDisplay.call(this);

                    // Bad collision FX
                    this.cameras.main.flash(200, 255, 0, 0); // Red flash
                    if (navigator.vibrate) navigator.vibrate(200); // Vibrate
                    emitterSplat.emitParticleAt(itemX, itemY);

                    showFloatingText.call(this, player.x, player.y, '¬°VETE A UN STARBUCKS!', '#00FF00');
                    if (lives <= 0) gameOver.call(this, score);
                } else {
                    score += 25;
                    showFloatingText.call(this, player.x, player.y, '¬°CRUNCH!', '#FFFF00');
                    emitterCrumbs.emitParticleAt(itemX, itemY);
                }
            } else if (type === 'factura') {
                 if (!isInvincible) {
                    score = Math.max(0, score - 50);
                    showFloatingText.call(this, player.x, player.y, '¬°DOLOROSA! -50', '#888888');
                    this.cameras.main.flash(100, 200, 200, 200);
                 }
            } else if (type === 'carajillo') {
                isInvincible = true;
                player.setTint(0xFFD700);
                player.setScale(0.15);
                emitterSparks.emitParticleAt(itemX, itemY, 30);
                showFloatingText.call(this, player.x, player.y, '¬°O√çDO COCINA!', '#FFFFFF');
                this.time.delayedCall(6000, () => {
                    isInvincible = false;
                    player.clearTint();
                    player.setScale(0.12);
                });
            }
            scoreText.setText('CU√ëADISMO: ' + score);
        }

        function showFloatingText(x, y, message, color) {
            let text = this.add.text(x, y - 20, message, { fontSize: '20px', fontStyle: 'bold', fill: color, stroke: '#000', strokeThickness: 3 });
            this.tweens.add({
                targets: text,
                y: y - 120,
                alpha: 0,
                duration: 2500,
                ease: 'Power2',
                onComplete: () => text.destroy()
            });
        }

        function updateLivesDisplay() {
            let text = "SERVILLETAS: ";
            for(let i=0; i<lives; i++) text += "üßª";
            livesText.setText(text);
        }

        function update() {
            background.tilePositionY -= 1;
            items.children.iterate(child => {
                if (child && child.y > config.height + 50) child.destroy();
            });
        }

        async function getHash(message) {
            if (window.crypto && crypto.subtle) {
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            } else {
                return "unsafe-" + btoa(message);
            }
        }

        async function gameOver(finalScore) {
            if (!gameActive) return;
            gameActive = false;

            if (spawnEvent) spawnEvent.remove();
            if (timerEvent) timerEvent.remove();

            if (bgm) bgm.stop();

            if (GAME_OVER_AUDIO_URL) {
                const audio = new Audio(GAME_OVER_AUDIO_URL);
                audio.play().catch(e => console.log("Game over audio play failed", e));
            }

            this.physics.pause();
            player.setTint(0xff0000);

            const screen = document.getElementById('game-over-screen');
            const scoreDisplay = document.getElementById('final-score-text');
            const statusDisplay = document.getElementById('status-text');
            scoreDisplay.innerText = "Puntuaci√≥n: " + finalScore;
            screen.style.display = 'flex';

            const hash = await getHash(`${USER_ID}${finalScore}${SECRET}`);
            try {
                const response = await fetch('/game/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        score: finalScore,
                        inline_message_id: INLINE_MESSAGE_ID,
                        chat_id: CHAT_ID,
                        message_id: MESSAGE_ID,
                        hash: hash
                    })
                });
                if (response.ok) statusDisplay.innerText = "¬°Puntos guardados en el ranking!";
                else statusDisplay.innerText = "Puntos no guardados (Error de servidor)";
            } catch (e) {
                console.error("Score submission error", e);
                statusDisplay.innerText = "Error de conexi√≥n al guardar puntos.";
            }
        }
    </script>
    <script src="https://telegram.org/js/games.js"></script>
</body>
</html>
