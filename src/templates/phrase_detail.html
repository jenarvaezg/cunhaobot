{% extends "base.html" %}

{% set is_private_contributor = contributor and contributor.is_private and (not user or user.id|string != contributor.id|string) %}

{% block meta %}
    <meta name="description" content="{{ phrase.text }} - Una perla de sabiduría cuñadil.">

    <!-- Open Graph -->
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="CuñaoBot">
    <meta property="og:locale" content="es_ES">
    <meta property="og:title" content="Frase de Cuñado: {{ phrase.text | truncate(50) }}">
    <meta property="og:description" content="&quot;{{ phrase.text }}&quot; {% if contributor and not is_private_contributor %}- Por {{ contributor.name }}{% endif %}">
    <meta property="og:url" content="{{ request.base_url }}{{ request.url.path }}">

    {% if phrase.sticker_file_id %}
    <meta property="og:image" content="{{ request.base_url }}/phrase/{{ phrase.id }}/sticker.png">
    <meta property="og:logo" content="{{ request.base_url }}/phrase/{{ phrase.id }}/sticker.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="{{ request.base_url }}/phrase/{{ phrase.id }}/sticker.png">
    {% else %}
    <meta property="og:image" content="{{ request.base_url }}/static/favicon.png">
    <meta property="og:logo" content="{{ request.base_url }}/static/favicon.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="{{ request.base_url }}/static/favicon.png">
    {% endif %}

    <!-- Twitter -->
    <meta name="twitter:title" content="Frase de Cuñado: {{ phrase.text | truncate(50) }}">
    <meta name="twitter:description" content="&quot;{{ phrase.text }}&quot; {% if contributor and not is_private_contributor %}- Por {{ contributor.name }}{% endif %}">
{% endblock %}
{% block content %}
<div class="row justify-content-center animate__animated animate__fadeIn">
    <div class="col-lg-8">
        <div class="d-flex align-items-center mb-4 gap-3">
            <a href="/" class="btn btn-outline-secondary rounded-pill border-0">
                <i class="bi bi-arrow-left fs-4"></i>
            </a>
            <h1 class="oswald mb-0">Detalle de Sabiduría</h1>
        </div>

        <div class="glass-card p-5 mb-5 border-top border-warning border-4">
            <div class="mb-4">
                <span class="badge bg-warning text-dark text-uppercase letter-spacing-2 mb-3">
                    {{ phrase.kind if phrase.kind == 'Phrase' else 'Dicho Cuñadil' }}
                </span>
                <blockquote class="display-5 fw-bold mb-0" style="line-height: 1.2;">
                    "{{ phrase.text }}"
                </blockquote>
            </div>

            <hr class="border-secondary border-opacity-25 my-5">

            <div class="row g-4">
                <div class="col-md-6">
                    <div class="stat-card p-4 rounded-4 h-100 d-flex flex-column justify-content-center">
                        <div class="text-secondary small text-uppercase fw-bold mb-2 text-center">Impacto Total</div>
                        <div class="d-flex align-items-baseline gap-2 justify-content-center">
                            <span class="display-4 fw-bold text-gold-gradient">{{ phrase.usages }}</span>
                            <span class="text-secondary">intervenciones</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="stat-card p-4 rounded-4 h-100 d-flex flex-column justify-content-center">
                        <div class="text-secondary small text-uppercase fw-bold mb-3 text-center">Autoría Original</div>
                        {% if contributor %}
                        <a href="/user/{{ contributor.id }}/profile" class="text-decoration-none text-white">
                            <div class="d-flex align-items-center gap-3 justify-content-center p-2 rounded-pill hover-bg-light-10 transition-all">
                                <div class="rounded-circle border border-warning border-opacity-50 d-flex align-items-center justify-content-center fw-bold text-dark overflow-hidden shadow-sm"
                                     style="width: 56px; height: 56px; background: var(--primary-gold);">
                                    {% if is_private_contributor %}
                                        <i class="bi bi-eye-slash-fill fs-4 text-dark"></i>
                                    {% else %}
                                        <img src="/user/{{ contributor.id }}/photo.png"
                                             alt="{{ contributor.name }}"
                                             class="img-fluid"
                                             style="width: 100%; height: 100%; object-fit: cover;"
                                             onerror="this.style.display='none'; this.parentElement.innerHTML='{{ contributor.name.lstrip('@')|first|upper }}'">
                                    {% endif %}
                                </div>
                                <div class="text-start">
                                    <div class="fw-bold fs-5 lh-1">
                                        {% if is_private_contributor %}
                                            Usuario Privado
                                        {% else %}
                                            {{ contributor.name }}
                                        {% endif %}
                                    </div>
                                    {% if not is_private_contributor and contributor.username %}
                                    <div class="small text-warning">@{{ contributor.username }}</div>
                                    {% else %}
                                    <div class="small text-secondary">Cuñao Certificado</div>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        {% else %}
                        <div class="d-flex align-items-center gap-3 justify-content-center">
                            <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center fw-bold text-dark shadow-sm" style="width: 56px; height: 56px;">
                                <i class="bi bi-person-fill fs-4"></i>
                            </div>
                            <div>
                                <div class="fw-bold text-white fs-5">{% if phrase.user_id and phrase.user_id != 0 %}{{ phrase.user_id }}{% else %}Anónimo{% endif %}</div>
                                <div class="small text-secondary">Contribuidor</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-4 stat-card rounded-4 h-100">
                        <i class="bi bi-volume-up text-info display-5 mb-3 d-block transition-transform hover-scale" style="cursor: pointer;" onclick="toggleAudio()"></i>
                        <div class="fw-bold fs-4 mb-1">{{ phrase.audio_usages }}</div>
                        <div class="small text-secondary text-uppercase mb-3">Audios Generados</div>
                        <audio id="phrase-audio" src="/phrase/{{ phrase.id }}/audio.ogg"></audio>
                        <button class="btn btn-sm btn-outline-info rounded-pill px-4 fw-bold" onclick="toggleAudio()">
                            <i class="bi bi-play-fill me-1"></i> Reproducir
                        </button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-4 stat-card rounded-4 h-100 d-flex flex-column justify-content-center">
                        <i class="bi bi-sticky text-warning display-5 mb-3 d-block"></i>
                        <div class="fw-bold fs-4 mb-1">{{ phrase.sticker_usages }}</div>
                        <div class="small text-secondary text-uppercase">Stickers Enviados</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-4 stat-card rounded-4 h-100 d-flex flex-column justify-content-center">
                        <i class="bi bi-calendar3 text-success display-5 mb-3 d-block"></i>
                        <div class="fw-bold fs-4 mb-1">{{ phrase.created_at.strftime('%d/%m/%Y') if phrase.created_at else '---' }}</div>
                        <div class="small text-secondary text-uppercase">Fecha Registro</div>
                    </div>
                </div>
            </div>
        </div>

        {% if phrase.sticker_file_id %}
        <div class="glass-card p-4 text-center animate__animated animate__fadeInUp animate__delay-1s mb-4">
            <h5 class="oswald mb-4 text-warning"> Sticker Oficial</h5>
            <div class="sticker-preview mx-auto mb-3 shadow-lg" style="width: 256px; height: 256px; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0) 70%); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                <img src="/phrase/{{ phrase.id }}/sticker.png" alt="Sticker" class="img-fluid" style="max-height: 220px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5)); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.1) rotate(2deg)'" onmouseout="this.style.transform='scale(1) rotate(0)'">
            </div>
            <div class="badge bg-dark border border-secondary text-secondary font-monospace">{{ phrase.sticker_file_id }}</div>
        </div>
        {% endif %}

        {% include "partials/ai_image.html" with context %}
    </div>
</div>

<script>
    function toggleAudio() {
        const audio = document.getElementById('phrase-audio');
        if (audio.paused) {
            audio.play();
        } else {
            audio.pause();
            audio.currentTime = 0;
        }
    }
</script>

<style>
    .letter-spacing-2 { letter-spacing: 2px; }
    .stat-card {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .stat-card:hover {
        background: rgba(30, 41, 59, 0.6) !important;
        border-color: rgba(var(--primary-gold-rgb), 0.3) !important;
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .hover-bg-light-10:hover { background: rgba(255,255,255,0.05); }
    .hover-scale:hover { transform: scale(1.1); }
    .transition-all { transition: all 0.3s ease; }
    .transition-transform { transition: transform 0.3s ease; }
</style>
{% endblock %}
