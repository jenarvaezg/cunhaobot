name: CI/CD - Test and Deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# Evita que se solapen dos despliegues si haces varios pushes seguidos
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Run Pre-commit Hooks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.14"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --dev

      - name: Run pre-commit hooks
        run: uv run pre-commit run --all-files

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          python-version: "3.14"
          enable-cache: true

      - name: Install dependencies
        run: uv sync --dev

      - name: Run pytest
        run: uv run pytest

  deploy:
    name: Deploy to App Engine
    needs: [lint, test]  # Solo intenta desplegar si ambos terminan con éxito
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Create app.yaml from template
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          MOD_CHAT_ID: ${{ secrets.MOD_CHAT_ID }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          BASE_URL: ${{ secrets.BASE_URL }}
          OWNER_ID: ${{ secrets.OWNER_ID }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          SLACK_CLIENT_ID: ${{ secrets.SLACK_CLIENT_ID }}
          SLACK_CLIENT_SECRET: ${{ secrets.SLACK_CLIENT_SECRET }}
          SLACK_SIGNING_SECRET: ${{ secrets.SLACK_SIGNING_SECRET }}
          TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TWITTER_CONSUMER_KEY_SECRET: ${{ secrets.TWITTER_CONSUMER_KEY_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          envsubst '$TG_TOKEN $MOD_CHAT_ID $AWS_ACCESS_KEY $AWS_SECRET_KEY $BASE_URL $OWNER_ID $SESSION_SECRET $SLACK_CLIENT_ID $SLACK_CLIENT_SECRET $SLACK_SIGNING_SECRET $TWITTER_CONSUMER_KEY $TWITTER_CONSUMER_KEY_SECRET $TWITTER_ACCESS_TOKEN $TWITTER_ACCESS_SECRET' < app.yaml.example > app.yaml

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Deploy to App Engine
        uses: google-github-actions/deploy-appengine@v2
        with:
          promote: true
          flags: --stop-previous-version
          deliverables: app.yaml cron.yaml

      - name: Cleanup old versions
        run: |
          # Borra todas las versiones que NO están recibiendo tráfico
          gcloud app versions list --format="value(id)" --filter="traffic_split=0" | xargs -r gcloud app versions delete --quiet
